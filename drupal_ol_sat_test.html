<!DOCTYPE html>
<html lang="en">
  <head>

	<!-- jquery  -->
	<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
	<script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>

    <!--Bootstrap --> 
	<link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
	<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

	<!-- open layers -->
	<script src="http://ol3js.org/en/master/build/ol.js" type="text/javascript"></script>
	
	<!-- stylesheet -->
	<link href="css/style.css" rel="stylesheet">

	<!-- rotation  -->
	<script type="text/javascript" src="http://dev.aegaron.ucla.edu/js/jrotate.js"></script>

<script type="text/javascript">

// map options	
var map,map1,map2,map3;
var viewState;
var zoomLevel = 12;
var planOverlay2;
var myOptions1,myOptions2,myOptions3;
var layers = [];

// Temporary static ArcGIS web service layers
var attribution = new ol.Attribution({
  html: 'Aegaron|UCLAÂ©2014'
});

var bing = 
  new ol.layer.Tile({
    visible: true,
    preload: Infinity,
    source: new ol.source.BingMaps({
      key: 'Ak-dzM4wZjSqTlzveKz5u0d4IQ4bRzVI309GxmkgSVr1ewS6iPSrOvOKhA-CJlm3',
      imagerySet: 'Road'
    })
  });

layers.push(bing);

// arclayer1 = new ol.layer.Tile({
//   source: new ol.source.XYZ({
//     attributions: [attribution],
//     url: 'http://whippet.ats.ucla.edu/arcgis/rest/services/aegaron/0001_NonGeoref/ImageServer/tile/{z}/{y}/{x}'
//   })
// });

// layers.push(arclayer1);



arclayer2 = new ol.layer.Tile({
  source: new ol.source.XYZ({
    attributions: [attribution],
    url: 'http://whippet.ats.ucla.edu/arcgis/rest/services/aegaron/0002_NonGeoref/ImageServer/tile/{z}/{y}/{x}'
  })
});

// apollo satellite... can't get it to show
arclayer2 = new ol.layer.Tile({
  source: new ol.source.XYZ({
    attributions: [attribution],
    url: 'http://whippet.ats.ucla.edu/arcgis/rest/services/aegaron_satellite/apollo_Philae_Satet_House/ImageServer/tile/{z}/{y}/{x}'
    // url: 'http://whippet.ats.ucla.edu/arcgis/rest/services/aegaron_satellite/Philae_Satet_House_webmercator/ImageServer/tile/{z}/{y}/{x}'
  })
});

layers.push(arclayer2);



function init(){
	map1 = new ol.Map({
	  target: 'map',
	  layers: layers,
	  view: new ol.View2D({
	    center: ol.proj.transform([32.885257, 24.05581], 'EPSG:4326', 'EPSG:3857'), //philae
	    // center: ol.proj.transform([31.2107, 29.7903], 'EPSG:4326', 'EPSG:3857'),
	    zoom: 12
	  })
	});
}

function dualView(viewState)
{
	if (viewState == 0)
	{
		$('#mapcontainer2').hide();
		$('#mapcontainer').show();
		$('#map-nav2').hide();
		$('#map-nav').show();

		map1 = new ol.Map({
			interactions: ol.interaction.defaults().extend([
				new ol.interaction.DragRotateAndZoom()
			]),
			layers: [layers[0]],
			// Use the canvas renderer because it's currently the fastest
			renderer: ol.RendererHint.CANVAS,

			target: 'map2',
			view: new ol.View2D({
				center: ol.proj.transform([centerLatLon.lng(),centerLatLon.lat()], 'EPSG:4326', 'EPSG:3857'),
				zoom: zoomLevel
			})
		});
	}
	else if (viewState == 1)
	{
		$('#mapcontainer').hide();
		$('#mapcontainer2').show();
		$('#map-nav').hide();
		$('#map-nav2').show();


		map2 = new ol.Map({
			target: 'map2',
			layers: [layers[0]],
			view: new ol.View2D({
				center: ol.proj.transform([31.2107, 29.7903], 'EPSG:4326', 'EPSG:3857'),
				zoom: 12
			})
		});

		map3 = new ol.Map({
			target: 'map3',
			layers: [layers[1]],
			view: new ol.View2D({
				center: ol.proj.transform([31.2107, 29.7903], 'EPSG:4326', 'EPSG:3857'),
				zoom: 12
			})
		});

		map2.bindTo('layergroup', map1);
		map2.bindTo('view',map1);
		map3.bindTo('view', map2);
		// map2.bindTo('view', map1);
	}
}

function getRelatedPlans()
{
	// var url = 'http://digidev.library.ucla.edu/axis2/services/AegaronServiceProvider/getPlanGeospatialMetadataByBoundingBox?northBL='+northBL+'&southBL='+southBL+'&eastBL='+eastBL+'&westBL='+westBL+'&response=application/json';
	var url = 'http://dlws.library.ucla.edu/axis2/services/AegaronServiceProvider/getPlanGeospatialMetadataByBoundingBox?northBL='+northBL+'&southBL='+southBL+'&eastBL='+eastBL+'&westBL='+westBL+'&response=application/json';
	encodedurl = 'http://dev.aegaron.ucla.edu/application/views/templates/proxy_json.php?url='+encodeURIComponent(url);
	
	$.getJSON(encodedurl,function(data){
		$.each(data.return,function(i,item){
            $("#changecompare").append('<option value='+item.id+'>'+item.title+' ('+item.drawingNumber+')</option>');
        })
	});
}

function switchCompareMap()
{
	var compareID = $('#changecompare').val();

	// var url = 'http://digidev.library.ucla.edu/axis2/services/AegaronServiceProvider/getPlanGeospatialMetadata?ark='+compareID+'&response=application/json';
	var url = 'http://dlws.library.ucla.edu/axis2/services/AegaronServiceProvider/getPlanGeospatialMetadata?ark='+compareID+'&response=application/json';
	encodedurl = 'http://dev.aegaron.ucla.edu/application/views/templates/proxy_json.php?url='+encodeURIComponent(url);
	
	$.getJSON(encodedurl,function(data){
		var tileurl2 = data.return.urlForTitles;
		planOverlay2 = new google.maps.ImageMapType(
		{
			getTileUrl: function(ll, z) 
			{
				var X = ll.x % (1 << z);  // wrap
				return tileurl2 + z + "/" + X + "/" + ll.y + ".png";
			},
			tileSize: new google.maps.Size(256, 256),
			isPng: true,
			maxZoom: 22
		});
		
		switchMap(planOverlay2,map3);
	});
}

function disableSync()
{
    google.maps.event.clearListeners(map2, 'center_changed');
    google.maps.event.clearListeners(map2, 'zoom_changed');
}
	
function enableSync()
{
    map3.panTo(map2.getCenter());
    map3.setZoom(map2.getZoom());
    //adding event listener to sync maps
    google.maps.event.addListener(map2, 'center_changed', function(event) {
       map3.panTo(map2.getCenter());
    });
    google.maps.event.addListener(map2, 'zoom_changed', function(event) {
		map3.setZoom(map2.getZoom());
	}); 
}

function rotate(num)
{
    var curangle = $('#map2').getRotateAngle();
    var nextangle = Number(curangle) + Number(num);
    if(num === 0) nextangle = 0;

    $('#map').rotate({
        angle: curangle, 
        animateTo: nextangle
    })
    $('#map2').rotate({
        angle: curangle, 
        animateTo: nextangle
    })
    $('#map3').rotate({
        angle: curangle, 
        animateTo: nextangle
    })
}

function enforceMaxZoom(map,switch2map)
{
	//attempting to allow maxzoom beyond 21 (buggy)
    google.maps.event.addListener(map, 'tilesloaded', function (event) {
        var mapTypeRegistry = map.mapTypes;
        var currentMapTypeId = map.getMapTypeId();
        var mapType = mapTypeRegistry.get(currentMapTypeId);
        mapType.maxZoom = 24;

    });
    
    google.maps.event.addListener(map, 'maptypeid_changed', function (event) {
        map.setOptions({ maxZoom: 24 });
    });

	// max zoom to 24 only works when you switch away from map type to satellite type and back to map type
	// this "hack" will automate the switch to force maxzoom 24
	var defaultzoom = map.getZoom();
	setTimeout(function(){
		map.setMapTypeId(google.maps.MapTypeId.SATELLITE)
		setTimeout(function(){
			if(switch2map)
			{
				map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
			}
			if(defaultzoom != map.getZoom())
			{
				map.setZoom(defaultzoom);
			}
			
			},100);
		
	},1000);		
}

function switchMap(planOverlay,map)
{
	
	map.overlayMapTypes.setAt(0, null);
	map.overlayMapTypes.insertAt(0, planOverlay);
    var handle = document.getElementById('handle'),
        start,
        startTop;

    document.onmousemove = function(e) {
        if (!start) return;
        // Adjust control
        handle.style.top = Math.max(-5, Math.min(195, startTop + parseInt(e.clientY, 10) - start)) + 'px';
        // Adjust opacity
        planOverlay.setOpacity(1 - (handle.offsetTop / 200));
        // map.parent.style.cursor = 'ns-resize';
    }

    handle.onmousedown = function(e) {
        // Record initial positions
        start = parseInt(e.clientY, 10);
        startTop = handle.offsetTop - 5;
        return false;
    }

    document.onmouseup = function(e) {
        start = null;
    }
}

function toggleSync()
{
	if($('#sync').html() == 'Sync Maps')
	{
		$('#sync').html('Disable Sync');
		enableSync();
	}
	else
	{
		$('#sync').html('Sync Maps');
		disableSync();
	}
}
</script>
</head>

<body onload="init()">

<div id="master-map-container" style="position: relative" >	
	<!-- single map -->
	<!-- map navigation bar -->
	<div id="map-nav" class="well container-fluid">
		<!-- <input type="radio" id="radio01" name="radio" checked="checked" /><label for="radio01">Single View</label>
		<input type="radio" id="radio02" name="radio" /><label for="radio01">Dual View</label> -->
		<span class="btn btn-info btn-small" onclick="dualView(0)"><span class="glyphicon glyphicon-stop"></span> Single View</span>
		<span class="btn btn-info btn-small" onclick="dualView(1)"><span class="glyphicon glyphicon-stop"></span><span class="glyphicon glyphicon-stop"></span> Dual View</span>
		|
		<!-- rotate the maps -->
          <span class="btn btn-small btn-info" onclick="rotate(-5);"><span class="glyphicon glyphicon-circle-arrow-left"></span></span>
          <span class="btn btn-small btn-info" onclick="rotate(0);"><span class="glyphicon glyphicon-refresh"></span>rotate</span>
          <span class="btn btn-small btn-info" onclick="rotate(5);"><span class="glyphicon glyphicon-circle-arrow-right"></span></span>
		<!-- show full screen button
					<a href="http://dev.aegaron.ucla.edu/index.php/welcome/fullscreen/21198_zz002c2g4c/" target="_blank" title="full screen" class="btn btn-small btn-inverse" style="float: right"><i class="icon-fullscreen icon-white"></i></a>
		 -->
	</div>
	
	<!-- dual map navigation -->
	<div id = "map-nav2" style="display:none;" class="well container-fluid">
		<span class="btn btn-info btn-small" onclick="dualView(0)"><span class="glyphicon glyphicon-stop"></span> Single View</span>
		<span class="btn btn-info btn-small" onclick="dualView(1)"><span class="glyphicon glyphicon-stop"></span><span class="glyphicon glyphicon-stop"></span> Dual View</span>
		|
		<!-- rotate the maps -->
          <span class="btn btn-small btn-info" onclick="rotate(-5);"><span class="glyphicon glyphicon-circle-arrow-left"></span></span>
          <span class="btn btn-small btn-info" onclick="rotate(0);"><span class="glyphicon glyphicon-refresh"></span>rotate</span>
          <span class="btn btn-small btn-info" onclick="rotate(5);"><span class="glyphicon glyphicon-circle-arrow-right"></span></span>
	</div>
	
	<div id="map-nav3" class="well" style="display:none;">single | dual</div>

	<!-- map container for single map view -->
	<div id="mapcontainer" style="position: relative;">
		<div style="float: left;position: absolute;margin-top: 10px;margin-left: 10px;z-index: 100;">
			<button class="btn btn-mini btn-inverse" onclick="map1.getView().setZoom(map1.getView().getZoom()+1)"><span class="glyphicon glyphicon-zoom-in"></button>
			<button class="btn btn-mini btn-inverse" onclick="map1.getView().setZoom(map1.getView().getZoom()-1)"><span class="glyphicon glyphicon-zoom-out"></button>
		</div>
		<div style="clear: both;"></div>
		<div id="mapcontainer1"><div id="map">This will be a map</div><div class="reticule"></div></div>

		<!-- <div id="map" style="background-color: gray;width:100%;height:600px;"></div> -->
		
	</div>
	
	<!-- map container for dual map view -->
	<div id="mapcontainer2" style="position: relative;display:none;">
		<div style="float: left;position: absolute;margin-top: 10px;margin-left: 10px;z-index: 100;">
			<button class="btn btn-mini btn-inverse" onclick="map2.getView().setZoom(map2.getView().getZoom()+1)"><span class="glyphicon glyphicon-zoom-in"></span></button>
			<button class="btn btn-mini btn-inverse" onclick="map2.getView().setZoom(map2.getView().getZoom()-1)"><span class="glyphicon glyphicon-zoom-out"></span></button>
		</div>
		<div style="float: right;position: absolute;margin-top: 10px;right: 10px;z-index: 100;">
			<!-- <select class="span2" style="margin-bottom:0px;" onChange="switchCompareMap()" id="changecompare">
				<option value=1>Satellite</option> 
			</select> -->
			<button class="btn btn-mini btn-inverse" onclick="map3.getView().setZoom(map3.getView().getZoom()+1)"><i class="icon-zoom-in icon-white"></i></button>
			<button class="btn btn-mini btn-inverse" onclick="map3.getView().setZoom(map3.getView().getZoom()-1)"><i class="icon-zoom-out icon-white"></i></button>
		</div>
		<div style="clear: both;"></div>
		<div id="mapcontainer2-1"><div id="map2">This will be a map</div><div class="reticule"></div></div>
    	<div id="mapcontainer2-2"><div id="map3">This will be a map</div><div class="reticule"></div></div>
	</div>
</div>
  </body>
</html>
