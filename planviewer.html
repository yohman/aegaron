<!DOCTYPE html>
<html lang="en">
  <head>

	<!-- jquery  -->
	<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
	<script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>

    <!--Bootstrap --> 
	<link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
	<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

	<!-- open layers -->
	<script src="http://ol3js.org/en/master/build/ol.js" type="text/javascript"></script>
	
	<!-- stylesheet -->
	<link href="css/style.css" rel="stylesheet">

<script type="text/javascript">

// namespace
var aegaron = {};

// map options	
var map,map1,map2,map3;
var viewState;
var zoomLevel = 5;
var layers = [];
var mapid1;

var alllayers_map1 = []; // drop down array holder for all maps (map1)
var alllayers_map2 = []; // drop down array holder for all maps (map2)
var alllayers_map3 = []; // drop down array holder for all maps (map3)
var layerlookup = [];

// arcgis server url
var arcgisserverurl = 'http://whippet.ats.ucla.edu/arcgis/rest/services/aegaron_nongeo';

// launch of document ready
$( document ).ready(function() {

	// get the map id via url
	mapid1 = aegaron.getUrlVar('mapid1');

	// set a default map id if not provided
	if(mapid1 == '') { mapid1 = '0001'};

	// initialize the map
    aegaron.getAllPlans();

});

//detect when window has been resized
$( window ).resize(function() {
	aegaron.resize();
});

//resize the map
aegaron.resize = function()
{
	console.log('resizing...')
	var height = $(window).height()-80;
	$('#mapcontainer1-map').css('height',height);
	$('#mapcontainer2-map1').css('height',height);
	$('#mapcontainer2-map2').css('height',height);
	$('#map1').css('height',height);
	map1.updateSize();
}


aegaron.init = function()
{
	// call arcgis server to get all the plans
	aegaron.getAllPlans();
}

aegaron.getAllPlans = function()
{
	//
	//	NOTE:  This may change to a call to the Digital Library
	//

	// call arcgis server to get all aegaron map services
	$.getJSON(arcgisserverurl+'/?f=json',function(data){

		$.each(data.services,function(i,item){
			// just show the plan number
			var displaystring = item.name.replace("aegaron_nongeo/","");
			var splitname = item.name.split("/");

			// add to the drop down choices for all 3 map divs
			$("#changecompare1").append('<option value='+splitname[1]+'>'+splitname[1]+'</option>');
			$("#changecompare2").append('<option value='+splitname[1]+'>'+splitname[1]+'</option>');
			$("#changecompare3").append('<option value='+splitname[1]+'>'+splitname[1]+'</option>');

            // add to layer array for map 1
            var arclayer1 = new ol.layer.Tile({
            	mapid: 1,
				source: new ol.source.XYZ({
					url: 'http://whippet.ats.ucla.edu/arcgis/rest/services/'+ item.name +'/ImageServer/tile/{z}/{y}/{x}'
				})
			});
			// add to layer array for map 2
            var arclayer2 = new ol.layer.Tile({
            	mapid: 2,
				source: new ol.source.XYZ({
					url: 'http://whippet.ats.ucla.edu/arcgis/rest/services/'+ item.name +'/ImageServer/tile/{z}/{y}/{x}'
				})
			});
			// add to layer array for map 3
            var arclayer3 = new ol.layer.Tile({
            	mapid: 3,
				source: new ol.source.XYZ({
					url: 'http://whippet.ats.ucla.edu/arcgis/rest/services/'+ item.name +'/ImageServer/tile/{z}/{y}/{x}'
				})
			});

			// set each layer's visibility to false on default
			arclayer1.setVisible(false);
			arclayer2.setVisible(false);
			arclayer3.setVisible(false);

			// add them to the array holder
			alllayers_map1.push(arclayer1);
			alllayers_map2.push(arclayer2);
			alllayers_map3.push(arclayer3);

			// push to layerlookup array to be able to reference by plan id number
			// to draw layer, look it up first ex: layerlookup.indexOf('0085')
			layerlookup.push(displaystring);

			// when at last item, draw the requested map for map1
			if(i == data.services.length-1)
			{
				// create map1 (single view)
				map1 = new ol.Map({
					target: 'map1',
					layers: alllayers_map1,
					view: new ol.View({
						center: ol.proj.transform([0,0], 'EPSG:4326', 'EPSG:3857'), 
						zoom: zoomLevel
					})
				});
				aegaron.drawLayerByPlanID('map1',mapid1);

				// update the URL
				map1.on('moveend', aegaron.setUrlVars);

				// set the drop down values
				$('#changecompare1').val(mapid1);

				// size window based on client
				aegaron.resize();

			}
        })
	});
}

aegaron.drawLayerByPlanID = function(whichmap,id)
{
	if (whichmap == 'map1')
	{
		map1.getView().setCenter([0,0]);
		map1.getView().setZoom(5);
		map1.getView().setRotation(0)
		mapid1 = id;
		// set all existing plans to visible = false
		for(i in alllayers_map1){alllayers_map1[i].setVisible(false)};
		// get existing plan id by array index
		var index = layerlookup.indexOf(id);
		// set requested plan to visible
		alllayers_map1[index].setVisible(true);
	}
	else if (whichmap == 'map2')
	{
		// although this is map2, since map1 and map2 are synced, change map1
		map1.getView().setCenter([0,0]);
		map1.getView().setZoom(5);
		map1.getView().setRotation(0)
		mapid1 = id;
		// set all existing plans to visible = false
		for(i in alllayers_map2){alllayers_map2[i].setVisible(false)};
		// get existing plan id by array index
		var index = layerlookup.indexOf(id);
		// set requested plan to visible
		alllayers_map2[index].setVisible(true);		
	}	
	else if (whichmap == 'map3')
	{
		map3.getView().setCenter([0,0]);
		map3.getView().setZoom(5);
		map3.getView().setRotation(0)
		// set all existing plans to visible = false
		for(i in alllayers_map3){alllayers_map3[i].setVisible(false)};
		// get existing plan id by array index
		var index = layerlookup.indexOf(id);
		// set requested plan to visible
		alllayers_map3[index].setVisible(true);		
	}
}

aegaron.dualView = function(viewState)
{

	if (viewState == 0) //single view
	{
		$('#mapcontainer2').hide();
		$('#mapcontainer1').show();

				// create map1 (single view)
				map1 = new ol.Map({
					target: 'map1',
					layers: alllayers_map1,
					view: new ol.View({
						center: ol.proj.transform([0,0], 'EPSG:4326', 'EPSG:3857'), 
						zoom: zoomLevel
					})
				});
	}
	else if (viewState == 1) //dual view
	{
		$('#mapcontainer1').hide();
		$('#mapcontainer2').show();
		$('#changecompare2').val(mapid1);

		map2 = new ol.Map({
			target: 'map2',
			layers: alllayers_map2,
			view: new ol.View({
				center: ol.proj.transform([0,0], 'EPSG:4326', 'EPSG:3857'), 
				zoom: zoomLevel
			})
		});

		map3 = new ol.Map({
			target: 'map3',
			layers: alllayers_map3,
			view: new ol.View({
				center: ol.proj.transform([0,0], 'EPSG:4326', 'EPSG:3857'), 
				zoom: zoomLevel
			})
		});

		// sync (bind) map1 (single view) and map2 (dual view left side)
		map2.bindTo('layergroup',map1);
		map2.bindTo('view',map1);
	}
	}

aegaron.getUrlVar = function(key)
{
	var result = new RegExp(key + "=([^&]*)", "i").exec(window.location.search); 
	return result && unescape(result[1]) || ""; 
}

aegaron.setUrlVars=function(evt)
{
	var urlvars = 'planviewer.html?mapid1='+mapid1+'&center='+map1.getView().getCenter()+'&zoom='+map1.getView().getZoom();
	console.log(urlvars);
	history.pushState(null, "A new title!", urlvars);
}

aegaron.switchCompareMap=function(map)
{

	if(map == 'map1')
	{
		var compareID = $('#changecompare1').val();
		$('#changecompare2').val(compareID);
		aegaron.drawLayerByPlanID('map1',compareID);
	}
	else if (map == 'map2')
	{
		var compareID = $('#changecompare2').val();
		$('#changecompare1').val(compareID);
		aegaron.drawLayerByPlanID('map1',compareID); // change map1 (not map2) because map1 and map2 are synced	
	}
	else if (map == 'map3')
	{
		var compareID = $('#changecompare3').val();
		aegaron.drawLayerByPlanID('map3',compareID);		
	}
}

</script>
</head>

<body>

<div id="master-map-container">	
	<!-- map navigation bar -->
	<div id="map-nav" class="">
		<span class="btn btn-info btn-small" onclick="aegaron.dualView(0)"><span class="glyphicon glyphicon-stop"></span> Single View</span>
		<span class="btn btn-info btn-small" onclick="aegaron.dualView(1)"><span class="glyphicon glyphicon-stop"></span><span class="glyphicon glyphicon-stop"></span> Dual View</span>
		<p>Use <code>Alt</code>+<code>Shift</code>+drag to rotate the map.</p>
	</div>

	<!-- map container for single map view -->
	<div id="mapcontainer1">
		<div class="mapcontainer-nav-left">
			<div class="form-inline">
				<div class="form-group">
					<button class="btn btn-mini btn-inverse" onclick="map1.getView().setZoom(map1.getView().getZoom()+1)"><span class="glyphicon glyphicon-zoom-in"></button>
					<button class="btn btn-mini btn-inverse" onclick="map1.getView().setZoom(map1.getView().getZoom()-1)"><span class="glyphicon glyphicon-zoom-out"></button>
				</div>
				<div class="form-group">
					<select class="form-control" style="margin-bottom:0px;" onChange="aegaron.switchCompareMap('map1')" id="changecompare1">
						<option value=1>-- choose a main plan --</option> 
					</select>
				</div>
			</div>
		</div>
		<div style="clear: both;"></div>
		<div id="mapcontainer1-map"><div id="map1"></div></div>
		
	</div>
	
	<!-- map container for dual map view -->
	<div id="mapcontainer2">
		<div class="mapcontainer-nav-left">
			<div class="form-inline">
				<div class="form-group">
					<button class="btn btn-mini btn-inverse" onclick="map2.getView().setZoom(map2.getView().getZoom()+1)"><span class="glyphicon glyphicon-zoom-in"></span></button>
					<button class="btn btn-mini btn-inverse" onclick="map2.getView().setZoom(map2.getView().getZoom()-1)"><span class="glyphicon glyphicon-zoom-out"></span></button>
				</div>
				<div class="form-group">
					<select class="form-control" style="margin-bottom:0px;" onChange="aegaron.switchCompareMap('map2')" id="changecompare2">
						<option value=1>-- choose a main plan --</option> 
					</select>
				</div>
			</div>
		</div>
		<div class="mapcontainer-nav-right">
			<div class="form-inline">
				<div class="form-group">
					<select class="form-control" style="margin-bottom:0px;" onChange="aegaron.switchCompareMap('map3')" id="changecompare3">
						<option value=1>-- choose a second plan --</option> 
					</select>
				</div>
				<div class="form-group">
					<button class="btn btn-mini btn-inverse" onclick="map3.getView().setZoom(map3.getView().getZoom()+1)"><span class="glyphicon glyphicon-zoom-in"></span></button>
					<button class="btn btn-mini btn-inverse" onclick="map3.getView().setZoom(map3.getView().getZoom()-1)"><span class="glyphicon glyphicon-zoom-out"></span></button>
				</div>
			</div>
		</div>
		<div style="clear: both;"></div>
		<div id="mapcontainer2-map1"><div id="map2"></div></div>
    	<div id="mapcontainer2-map2"><div id="map3"></div></div>
	</div>
</div>
  </body>
</html>
