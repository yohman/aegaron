<!DOCTYPE html>
<html lang="en">
  <head>

	<!-- jquery  -->
	<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
	<script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>

    <!--Bootstrap --> 
	<link href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
	<script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

	<!-- open layers -->
	<script src="http://ol3js.org/en/master/build/ol.js" type="text/javascript"></script>
	<!-- <link href="http://ol3js.org/en/master/css/ol.css" rel="stylesheet">	 -->
	<!-- stylesheet -->
	<link href="css/style.css" rel="stylesheet">

<script type="text/javascript">

// namespace
var aegaron = {};

// map options	
var map,map1,map2,map3;
var viewState = 0; // 0 = single; 1 = dual
var zoomLevel = 19;
var layers = [];
var mapid1,mapid2;
var mapCenter = [3660710.823399583, 2756502.4598684157];

var alllayers_map1 = []; // drop down array holder for all maps (map1)
var alllayers_map2 = []; // drop down array holder for all maps (map2)
var alllayers_map3 = []; // drop down array holder for all maps (map3)
var layerlookup = [];
var current_opacity = 0.7;
var syncmaps = true;

// arcgis server url
var arcgisserverurl = 'http://whippet.ats.ucla.edu/arcgis/rest/services/aegaron_maps';
// var arcgisserverurl = 'http://whippet.ats.ucla.edu/arcgis/rest/services/temp';


// launch of document ready
$( document ).ready(function() {

	// get the map id via url
	mapid1 = aegaron.getUrlVar('mapid1');
	mapid2 = aegaron.getUrlVar('mapid2');

	// set a default map id if not provided
	if(mapid1 == '') { mapid1 = '0012'};

	// initialize the map
    aegaron.getAllPlansFromMosaic();

	aegaron.transparencySlider();

	aegaron.resize();

	// if second map is requested, load dual view
	if(mapid2 != '')
	{
		// aegaron.dualView(1);
		$('#loading').modal('show');
		setTimeout(function(){aegaron.dualView(1);$('#loading').modal('hide');},1500);
	}

	// hack to position mapdiv
	$('.ol-unselectable').css('position','absolute');
	$('.ol-unselectable').css('top','100px');

});

//detect when window has been resized
$( window ).resize(function() {
	aegaron.resize();
});

//resize the map
aegaron.resize = function()
{

	var height = $(window).height()-80;
	var width = $(window).width();
	$('#mapcontainer1-map').css('height',height);
	$('#mapcontainer2-map1').css('height',height);
	$('#mapcontainer2-map2').css('height',height);


	var buffer = 0;
	$('#map1').css('position','absolute');
	$('#map1').css('height',height+buffer);
	$('#map1').css('width',width+buffer);
	$('#map1').css('top',-(buffer/2));
	$('#map1').css('left',-(buffer/2));
	$('#map2').css('height',height);
	$('#map3').css('height',height);
	// map1.updateSize();

	if(map1){map1.updateSize();};
	if(map2){map2.updateSize();};
	if(map3){map3.updateSize();};
}

// add to layer array for map 1
// var satlayers = new ol.layer.Tile({
// 	mapid: 1,
// 	source: new ol.source.XYZ({
// 		url: 'http://whippet.ats.ucla.edu/arcgis/rest/services/aegaron_satellite/Philae/ImageServer/tile/{z}/{y}/{x}',
// 		maxZoom: 23
// 	}),
// 	visible: true
// });

var satlayers;

// satellite layer as a mosaic database




// add to layer array for map 1
alllayers_map1.push(satlayers);
alllayers_map2.push(satlayers);
alllayers_map3.push(satlayers);
layerlookup.push('satellite');

var mosaicData;

aegaron.getAllPlansFromMosaic = function()
{

	var url = 'http://whippet.ats.ucla.edu/arcgis/rest/services/MosaicDataset/Aegaron_Dataset1/ImageServer/query?where=1=1&outFields=*&returnGeometry=true&outSR=102100&f=pjson';
	$.getJSON(url,function(data){
		mosaicData = data.features;
		$.each(data.features,function(i,item){

			var name = item.attributes.Name;

			// add to the drop down choices for all 3 map divs
			$("#changecompare1").append('<option value='+name+'>'+name+'</option>');
			$("#changecompare2").append('<option value='+name+'>'+name+'</option>');
			$("#changecompare3").append('<option value='+name+'>'+name+'</option>');

		});


		// create map1 (single view)
		map1 = new ol.Map({
			target: 'map1',
			// layers: alllayers_map1,
			layers: [
				new ol.layer.Tile({
					source: new ol.source.MapQuest({layer: 'sat'})
				})
			],
			view: new ol.View({
				center: mapCenter, 
				zoom: zoomLevel,
				// rotation: Math.PI / 6
			})
		});
		// turn off temporary baselayer
		map1.getLayers().getArray()[0].setVisible(false)



		map2 = new ol.Map({
			target: 'map2',
			// layers: alllayers_map2,
			layers: [
				new ol.layer.Tile({
					source: new ol.source.MapQuest({layer: 'sat'})
				})
			],
			view: new ol.View({
				center: map1.getView().getCenter(),
				zoom: zoomLevel
			})
		});

		map3 = new ol.Map({
			target: 'map3',
			// layers: alllayers_map3,
			layers: [
				new ol.layer.Tile({
					source: new ol.source.MapQuest({layer: 'sat'})
				})
			],
			view: new ol.View({
				center: mapCenter, 
				zoom: zoomLevel
			})
		});

		// bind/sync the maps in dual view
		map2.bindTo('layergroup',map1);
		map2.bindTo('view',map1);
		map3.bindTo('view',map2);




		// aegaron.drawLayerByPlanID('map1',mapid1);
		// aegaron.drawLayerByPlanID('map2',mapid1);

		// draw second map if dual view is on 
		if(mapid2)
		{
			// aegaron.drawLayerByPlanID('map3',mapid2);
		};

		// update the URL
		// map1.on('moveend', aegaron.setUrlVars);

		// set the drop down values
		$('#changecompare1').val(mapid1);
		$('#changecompare2').val(mapid1);
		$('#changecompare3').val(mapid2);


		aegaron.switchCompareMap('map1');

		// ask for image to be redrawn every time map view changes
		map1.on('moveend', function(){aegaron.redrawOnMoveend()});
		map2.on('moveend', function(){aegaron.redrawOnMoveend()});
		map3.on('moveend', function(){aegaron.redrawOnMoveend()});
	})

}

aegaron.redrawOnMoveend = function()
{
	redrawLayer('map1');
	redrawLayer('map2');
	redrawLayer('map3');
}

var thismapid = 11;
var layer1;

function searchArray(nameKey, myArray){
    for (var i=0; i < myArray.length; i++) {
        if (myArray[i].attributes.Name === nameKey) {
            return myArray[i];
        }
    }
}

// convert mapid's (ex '0011') to object id's
aegaron.mapid2objectid = function(mapid)
{
	for (var i=0; i < mosaicData.length; i++) 
	{
		if (mosaicData[i].attributes.Name === mapid)
		{
			return mosaicData[i].attributes.OBJECTID;
		}
	}
}

// convert mapid's (ex '0011') to object id's
aegaron.getExtentByMapID = function(mapid)
{
	for (var i=0; i < mosaicData.length; i++) 
	{
		if (mosaicData[i].attributes.Name === mapid)
		{
			return new ol.extent.boundingExtent(mosaicData[i].geometry.rings[0]);
		}
	}
}
var counter = 1;

function getBbox(mapdivid)
{
	var thisSize = getSize(mapdivid);
	return aBox = window[mapdivid].getView().calculateExtent(thisSize);
	// return aBox = window[mapdivid].getView().calculateExtent(window[mapdivid].getSize());
}

function getSize(mapdivid)
{
	var padding = 0;
	return [window[mapdivid].getSize()[0]*window.devicePixelRatio+padding,window[mapdivid].getSize()[1]*window.devicePixelRatio+padding];
}


function redrawLayer(mapdivid)
{
	// only redraw map2 and map3 if viewState = 1
	if(viewState == 0 && mapdivid == 'map2') { return false; };
	if(viewState == 0 && mapdivid == 'map3') { return false; };

	// putting mapdivid in a window[] array allows you to use a variable to call a global object
	// remove any existing overlays
	// if(window[mapdivid].getLayers().getArray().length > 1)
	// {
	// 	window[mapdivid].removeLayer(window[mapdivid].getLayers().getArray()[1]);
	// }

	for(i = 0; i <= window[mapdivid].getLayers().getArray().length; i++) {window[mapdivid].removeLayer(window[mapdivid].getLayers().getArray()[0]);}


	// get the bounding box of current map
	var thisbbox = getBbox(mapdivid);
	var thissize = getSize(mapdivid);

	var polygon = [
		[
			[thisbbox[0],thisbbox[1]],
			[thisbbox[2],thisbbox[1]],
			[thisbbox[2],thisbbox[3]],
			[thisbbox[0],thisbbox[3]],
			[thisbbox[0],thisbbox[1]]
		]
	];

	var currentRotation = map1.getView().getRotation()*(180/Math.PI)
	if (currentRotation > 0) {
		// getRIGHTBbox(mapdivid);
		console.log('yoh, the rotation is '+currentRotation+" degrees" )
		var height = $(window).height()-80;
		var width = $(window).width();

		var buffer = 400;
		$('#map1').css('position','absolute');
		$('#map1').css('height',height+buffer);
		$('#map1').css('width',width+buffer);
		$('#map1').css('top',-(buffer/2));
		$('#map1').css('left',-(buffer/2));


	}


	// get the pixel size of the div
	// make sure to compensate for retina displays (window.devicePixelRatio)




	// set which map to get
	if(mapdivid == 'map1' || mapdivid == 'map2')
	{
		// get the objectID for this mapid
		var objectID = aegaron.mapid2objectid(mapid1);
	}
	else
	{
		// get the objectID for this mapid
		var objectID = aegaron.mapid2objectid(mapid2);
	}

	console.log('log#: '+counter)
	counter++;

	if(objectID!==undefined)
	{

		// draw satellite first
		// add satellite mosaic database
		var url = 'http://whippet.ats.ucla.edu/arcgis/rest/services/Aegaron_SatImg/ImageServer/exportImage?f=image&bbox='+thisbbox+'&imageSR=102100&bboxSR=102100&size='+thissize;
		var satlayer1 = new ol.layer.Image({
			source: new ol.source.ImageMapGuide({
				url: url
			}),
			extent: thisbbox
		})
		window[mapdivid].addLayer(satlayer1);






		url = 'http://whippet.ats.ucla.edu/arcgis/rest/services/MosaicDataset/Aegaron_Dataset1/ImageServer/exportImage?f=image&bbox='+thisbbox+'&imageSR=102100&bboxSR=102100&size='+thissize+'&mosaicRule={%22mosaicMethod%22:%22esriMosaicLockRaster%22,%22lockRasterIds%22:['+objectID+']}';
		layer1 = new ol.layer.Image({
			source: new ol.source.ImageMapGuide({
				url: url
			}),
			extent: thisbbox

		})
		// add the image to the map as an overlay
		window[mapdivid].addLayer(layer1);
		layer1.setOpacity(current_opacity);
		// aegaron.addPoly(polygon);
		// polygon = new ol.geom.Polygon({coordinates: thisbbox});
		// window[mapdivid].addLayer(polygon); 

	}

}

aegaron.addPoly = function(polygon)
{
	var vectorSource = new ol.source.GeoJSON(
	/** @type {olx.source.GeoJSONOptions} */
	({
		object: {
			'type': 'FeatureCollection',
			// 'crs': {
			// 	'type': 'name',
			// 	'properties': {
			// 		'name': 'EPSG:3857'
			// 	}
			// },
			'features': [{
				'type': 'Feature',
				'geometry': {
					'type': 'Polygon',
					'coordinates': polygon
				}
			},  ]
		}
	}));


	var vectorLayer = new ol.layer.Vector({
	    source: vectorSource,
	    style: [new ol.style.Style({
	        stroke: new ol.style.Stroke({
	            color: 'blue',
	            lineDash: [4],
	            width: 3
	        }),
	        fill: new ol.style.Fill({
	            color: 'rgba(0, 0, 255, 0)'
	        })
	    })]
	});

	map1.addLayer(vectorLayer);

}

var polygon;
aegaron.dualView = function(view)
{
	if (view == 0)
	{
		$('#mapcontainer2').hide();
		$('#mapcontainer1').show();
		$('#sync-nav').hide();
		// $('#map-nav').show();
		map1.updateSize();
		viewState = 0;

	}
	else if (view == 1)
	{
		$('#mapcontainer1').hide();
		$('#mapcontainer2').show();
		$('#changecompare2').val(mapid1);
		$('#sync-nav').show();
		map2.updateSize();
		map3.updateSize();
		aegaron.resize();
		viewState = 1;
	}
}


aegaron.toggleSyncMaps = function()
{
	if(syncmaps)
	{
		map3.unbindAll();
		var oldView = map3.getView();
		map3.setView(new ol.View({
			center: oldView.getCenter().slice(),
			resolution: oldView.getResolution(),
			rotation: oldView.getRotation()
		}));
		$('#sync-button-text').html('Sync maps')
		syncmaps = false;
	}
	else
	{
		map3.bindTo('view',map2);
		$('#sync-button-text').html('Unsync maps')
		syncmaps = true;
	}

}

aegaron.getUrlVar = function(key)
{
	var result = new RegExp(key + "=([^&]*)", "i").exec(window.location.search); 
	return result && unescape(result[1]) || ""; 
}

aegaron.setUrlVars=function(evt)
{
	var urlvars = 'mapviewer_mosaic_albert.html?mapid1='+mapid1+'&mapid2='+mapid2+'&center='+map1.getView().getCenter()+'&zoom='+map1.getView().getZoom();
	history.pushState(null, "A new title!", urlvars);
}

aegaron.switchCompareMap=function(map)
{
	if(map == 'map1')
	{
		var compareID = $('#changecompare1').val();
		mapid1 = compareID;
		aegaron.setUrlVars();
		$('#changecompare2').val(compareID);

		// zoom to extent of new map
		var thisExtent = aegaron.getExtentByMapID(mapid1);

		map1.getView().fitExtent(thisExtent,map1.getSize());

		redrawLayer('map1');
		// aegaron.drawLayerByPlanID('map1',compareID);
	}
	else if (map == 'map2')
	{
		var compareID = $('#changecompare2').val();
		mapid1 = compareID;
		aegaron.setUrlVars();
		$('#changecompare1').val(compareID);

		// zoom to extent of new map
		var thisExtent = aegaron.getExtentByMapID(mapid1);
		map1.getView().fitExtent(thisExtent,map1.getSize());

		redrawLayer('map2');
		// aegaron.drawLayerByPlanID('map2',compareID); // change map1 (not map2) because map1 and map2 are synced	
	}
	else if (map == 'map3')
	{
		var compareID = $('#changecompare3').val();
		mapid2 = compareID;
		aegaron.setUrlVars();
		// // zoom to extent of new map
		// var thisExtent = aegaron.getExtentByMapID(mapid1);
		// map1.getView().fitExtent(thisExtent,map1.getSize());

		redrawLayer('map3');
		// aegaron.drawLayerByPlanID('map3',compareID);		
	}
}

aegaron.transparencySlider = function()
{
	var handle = document.getElementById('handle2'),
		start,
		startLeft;

	document.onmousemove = function(e) {

		if (!start) return;
		// Adjust control
		handle.style.left = Math.max(0, Math.min(190, startLeft + parseInt(e.clientX, 10) - start)) + 40 + 'px';
		// Adjust opacity
		var opacity = 1 - ((handle.offsetLeft-40) / 190);

		current_opacity = opacity;

		// aegaron.setOpacity(opacity);

		map1.getLayers().getArray()[1].setOpacity(opacity)
		map2.getLayers().getArray()[1].setOpacity(opacity)
		map3.getLayers().getArray()[1].setOpacity(opacity)


		// map.parent.style.cursor = 'ns-resize';
	}

	handle.onmousedown = function(e) {
		// Record initial positions
		start = parseInt(e.clientX, 0);
		startLeft = handle.offsetLeft - 40;
		return false;
	}

	document.onmouseup = function(e) {
		start = null;
	}	


	// var handle = document.getElementById('handle'),
	// 	start,
	// 	startTop;

	// document.onmousemove = function(e) {

	// 	if (!start) return;
	// 	// Adjust control
	// 	handle.style.top = Math.max(-5, Math.min(175, startTop + parseInt(e.clientY, 10) - start)) + 40 + 'px';
	// 	// Adjust opacity

	// 	var opacity = 1 - ((handle.offsetTop-35) / 180);

	// 	current_opacity = opacity;


	// 	for(i in alllayers_map1)
	// 	{
	// 		if(i != 0)
	// 		{
	// 			alllayers_map1[i].setOpacity(opacity);
	// 			alllayers_map2[i].setOpacity(opacity);
	// 			alllayers_map3[i].setOpacity(opacity);
	// 		}
	// 	}

	// 	// map.parent.style.cursor = 'ns-resize';
	// }

	// handle.onmousedown = function(e) {
	// 	// Record initial positions
	// 	start = parseInt(e.clientY, 0);
	// 	startTop = handle.offsetTop - 40;
	// 	return false;
	// }

	// document.onmouseup = function(e) {
	// 	start = null;
	// }	
}

aegaron.setOpacityFromSliderButtons = function(val)
{
	var this_opacity = current_opacity + val;
	aegaron.setOpacity(this_opacity);	
}

aegaron.setOpacity = function(val)
{
	var this_opacity = val;
	if(this_opacity>=1){ this_opacity = 1};
	if(this_opacity<0){ this_opacity = 0};

	current_opacity = this_opacity;
	// set the slider postion too
	var handleposition = 190-(this_opacity*190)+40+'px';
	handle2.style.left=handleposition;

	map1.getLayers().getArray()[1].setOpacity(this_opacity)
	map2.getLayers().getArray()[1].setOpacity(this_opacity)
	map3.getLayers().getArray()[1].setOpacity(this_opacity)
}

</script>
</head>

<body>

<div id="master-map-container">	
	<!-- map navigation bar -->
	<div id="map-nav" class="">
		<span class="btn btn-info btn-small" onclick="aegaron.dualView(0)"><span class="glyphicon glyphicon-stop"></span> Single View</span>
		<span class="btn btn-info btn-small" onclick="aegaron.dualView(1)"><span class="glyphicon glyphicon-stop"></span><span class="glyphicon glyphicon-stop"></span> Dual View</span>
		
		<!-- sync map button -->
		<span id="sync-nav" style="display:none;">
			|
			<span class="btn btn-info btn-small" onclick="aegaron.toggleSyncMaps()"><span class="glyphicon glyphicon-link"></span><span id="sync-button-text">Unsync Maps</span></span>
		</span>

		<!-- transparency slider -->
		&nbsp|&nbsp &nbsp 
		<span id='control-container2'>
			<span onclick="aegaron.setOpacityFromSliderButtons(.1)" class="btn btn-info time-control left-border-radius" style=""><span class="glyphicon glyphicon-minus-sign"></span></span>
			<div id='control2'>
				<span style="color: #aaa;padding-top:15px;line-height: 34px;">transparency</span>
				<span id='handle2'></span>
			</div>
			<span onclick="aegaron.setOpacityFromSliderButtons(-.1)" class="btn btn-info time-control right-border-radius" style=""><span class="glyphicon glyphicon-plus-sign"></span></span>
		</span>

		<!-- rotate instructions -->
		<p>Use <code>Alt</code>+<code>Shift</code>+drag to rotate the map.</p>
	</div>

	<!-- map container for single map view -->
	<div id="mapcontainer1">
		<div class="mapcontainer-nav-left">
			<div class="form-inline">
				<div class="form-group">
					<button class="btn btn-mini btn-info" onclick="map1.getView().setZoom(map1.getView().getZoom()+1)"><span class="glyphicon glyphicon-zoom-in"></button>
					<button class="btn btn-mini btn-info" onclick="map1.getView().setZoom(map1.getView().getZoom()-1)"><span class="glyphicon glyphicon-zoom-out"></button>
				</div>
				<div class="form-group">
					<select class="form-control" style="margin-bottom:0px;" onChange="aegaron.switchCompareMap('map1')" id="changecompare1">
						<option value=1>-- choose a main plan --</option> 
					</select>
				</div>
			</div>
		</div>
		<div style="clear: both;"></div>
		<div id="mapcontainer1-map"><div id="map1"></div></div>		
	</div>
	
	<!-- map container for dual map view -->
	<div id="mapcontainer2">
		<div class="mapcontainer-nav-left">
			<div class="form-inline">
				<div class="form-group">
					<button class="btn btn-mini btn-info" onclick="map2.getView().setZoom(map2.getView().getZoom()+1)"><span class="glyphicon glyphicon-zoom-in"></span></button>
					<button class="btn btn-mini btn-info" onclick="map2.getView().setZoom(map2.getView().getZoom()-1)"><span class="glyphicon glyphicon-zoom-out"></span></button>
				</div>
				<div class="form-group">
					<select class="form-control" style="margin-bottom:0px;" onChange="aegaron.switchCompareMap('map2')" id="changecompare2">
						<option value=1>-- choose a main plan --</option> 
					</select>
				</div>
			</div>
		</div>
		<div class="mapcontainer-nav-right">
			<div class="form-inline">
				<div class="form-group">
					<select class="form-control" style="margin-bottom:0px;" onChange="aegaron.switchCompareMap('map3')" id="changecompare3">
						<option value=1>-- choose a second plan --</option> 
					</select>
				</div>
				<div class="form-group">
					<button class="btn btn-mini btn-info" onclick="map3.getView().setZoom(map3.getView().getZoom()+1)"><span class="glyphicon glyphicon-zoom-in"></span></button>
					<button class="btn btn-mini btn-info" onclick="map3.getView().setZoom(map3.getView().getZoom()-1)"><span class="glyphicon glyphicon-zoom-out"></span></button>
				</div>
			</div>
		</div>
		<div style="clear: both;"></div>
		<div id="mapcontainer2-map1"><div id="map2"></div></div>
    	<div id="mapcontainer2-map2"><div id="map3"></div></div>
	</div>

	<!-- transparency slider
	<div id='control-container'>
		<div onclick="aegaron.setOpacity(.1)" class="btn btn-info btn-sm"><span class="glyphicon glyphicon-plus-sign"></span></div>
		<div id='control'>
			<div id='handle'></div>
		</div>
		<div onclick="aegaron.setOpacity(-.1)" class="btn btn-info btn-sm"><span class="glyphicon glyphicon-minus-sign"></span></div>
	</div>
 -->

	<div class="modal fade" id="loading">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
					<h4 class="modal-title">Loading dual view...</h4>
				</div>
				<div class="modal-body">
					<div class="progress">
						<div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 60%;">
							<span class="sr-only">60% Complete</span>
						</div>
					</div>
				</div>
			</div><!-- /.modal-content -->
		</div><!-- /.modal-dialog -->
	</div><!-- /.modal -->

</div>
</body>
</html>
