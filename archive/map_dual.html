<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Drawing - Philae, Central Buildings and Surroundings - Aegaron</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!--Bootstrap 2,3,1--> 
    <link href="http://dev.aegaron.ucla.edu/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="http://dev.aegaron.ucla.edu/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">

    <!-- Aegaron Style -->
    <link type="text/css" rel="stylesheet" href="http://dev.aegaron.ucla.edu/css/aegaron.css" />
    <!-- Relocated JS includes to footer -->
	
	<meta http-equiv='imagetoolbar' content='no'/>
	<style type="text/css"> v\:* {behavior:url(#default#VML);}
    	/*
		html, body { overflow: hidden; padding: 0; height: 100%; width: 100%; font-family: Arial,Verdana,sans-serif; }
		body { margin: 10px; background: #000; color: #fff; }
			h1 { margin: 0; padding: 6px; border:0; font-size: 20pt; }
			#header { height: 43px; padding: 0; background-color: #000; border: none; }
		#subheader { height: 12px; text-align: right; font-size: 10px; color: #555;}
		*/
		#map { height: 85%; }
	</style>	


<!-- Google Maps API Call -->
<script src="http://maps.google.com/maps/api/js?v=3&amp;sensor=false"></script>

<!-- open layers -->
<script src="http://ol3js.org/en/master/build/ol.js" type="text/javascript"></script>


<style type="text/css">
	#map-holder img {
		  max-width: none; 
	}
	#map{width:100%;height:1200px;position:absolute;top:50%;margin-top:-600px;}
	#map2{width:1200px;height:1200px;position:absolute;top:50%;left:50%;margin-top:-600px;margin-left:-600px;}
    #map3{width:1200px;height:1200px;position:absolute;top:50%;left:50%;margin-top:-600px;margin-left:-600px;}
    #mapcontainer1{width:100%;height:600px;background:#eee;position:relative;overflow:hidden;float:left;border:1px solid gray;}
    #mapcontainer2-1{width:49%;height:600px;background:#eee;position:relative;overflow:hidden;float:left;border:1px solid gray;}
    #mapcontainer2-2{width:49%;height:600px;background:#eee;position:relative;overflow:hidden;float:right;border:1px solid gray;}
	.reticule {
			    position:absolute;
			    width:16px;
			    height:16px;
			    left:50%;
			    top:50%;
			    margin-top:-8px;
			    margin-left:-8px;
			    }	
	#control {
		    background:#FFF;
		    position:absolute;
		    right:10px;
		    top:160px;
		    z-index:10;
		    height:200px;
		    width:28px;
		    border:1px solid #BBB;
		    -webkit-border-radius:3px;
		            border-radius:3px;
	}
	#handle {
		      background:#000;
		      position: absolute;
		      left:0;
		      top:20px;
		      width:28px;
		      height:10px;
	      }
	#handle:hover {
	      cursor:pointer;
	      background:#444;
	      cursor:ns-resize;
	}
</style>


<script type="text/javascript">

	var map,map1;
	var map2;
	var map3;
	var viewState;
	
	//These viariables need to be set dynamically based on what plan was chosen:
	// 	var centerLatLon = new google.maps.LatLng(29.790181565188544,31.210562799930585);
	// var zoomLevel = 17;
	// var tileURL = 'http://tiles.ats.ucla.edu/tiles/Aegaron_0005/';
	// var eastBL = 32.885283;
	// var westBL = 32.883446;
	// var northBL = 24.026198;
	// var southBL = 24.024835;

		var centerLatLon = new google.maps.LatLng(0,0);
	var zoomLevel = 12;
	var tileURL = 'http://tiles.ats.ucla.edu/tiles/Aegaron_0073/';
	var eastBL = 31.210700;
	var westBL = 31.210469;
	var northBL = 29.790369;
	var southBL = 29.790087;



	var planOverlay = new google.maps.ImageMapType(
	{
		getTileUrl: function(ll, z) 
		{
			var X = ll.x % (1 << z);  // wrap
			return tileURL + z + "/" + X + "/" + ll.y + ".png";
		},
		tileSize: new google.maps.Size(256, 256),
		isPng: true,
		maxZoom: 22
	});
	
	//default plan to map
	var planMap = planOverlay;
	var planOverlay2;
	// map options	
	var myOptions1,myOptions2,myOptions3;
	var layers = [];


	arclayer1 = new ol.layer.Tile({
	  source: new ol.source.XYZ({
	    // attributions: [attribution],
	    url: 'http://whippet.ats.ucla.edu/arcgis/rest/services/aegaron/0002_NonGeoref/ImageServer/tile/{z}/{y}/{x}'
	  })
	});

	layers.push(arclayer1);

	arclayer2 = new ol.layer.Tile({
	  source: new ol.source.XYZ({
	    // attributions: [attribution],
	    url: 'http://whippet.ats.ucla.edu/arcgis/rest/services/aegaron/0002_NonGeoref/ImageServer/tile/{z}/{y}/{x}'
	  })
	});

	layers.push(arclayer2);


	function getRelatedPlans()
	{

		// var url = 'http://digidev.library.ucla.edu/axis2/services/AegaronServiceProvider/getPlanGeospatialMetadataByBoundingBox?northBL='+northBL+'&southBL='+southBL+'&eastBL='+eastBL+'&westBL='+westBL+'&response=application/json';
		var url = 'http://dlws.library.ucla.edu/axis2/services/AegaronServiceProvider/getPlanGeospatialMetadataByBoundingBox?northBL='+northBL+'&southBL='+southBL+'&eastBL='+eastBL+'&westBL='+westBL+'&response=application/json';
		encodedurl = 'http://dev.aegaron.ucla.edu/application/views/templates/proxy_json.php?url='+encodeURIComponent(url);
		
		$.getJSON(encodedurl,function(data){
			$.each(data.return,function(i,item){
                $("#changecompare").append('<option value='+item.id+'>'+item.title+' ('+item.drawingNumber+')</option>');
            })
		});
	}
	
	function switchCompareMap()
	{
		var compareID = $('#changecompare').val();

		// var url = 'http://digidev.library.ucla.edu/axis2/services/AegaronServiceProvider/getPlanGeospatialMetadata?ark='+compareID+'&response=application/json';
		var url = 'http://dlws.library.ucla.edu/axis2/services/AegaronServiceProvider/getPlanGeospatialMetadata?ark='+compareID+'&response=application/json';
		encodedurl = 'http://dev.aegaron.ucla.edu/application/views/templates/proxy_json.php?url='+encodeURIComponent(url);
		
		$.getJSON(encodedurl,function(data){
			var tileurl2 = data.return.urlForTitles;
			planOverlay2 = new google.maps.ImageMapType(
			{
				getTileUrl: function(ll, z) 
				{
					var X = ll.x % (1 << z);  // wrap
					return tileurl2 + z + "/" + X + "/" + ll.y + ".png";
				},
				tileSize: new google.maps.Size(256, 256),
				isPng: true,
				maxZoom: 22
			});
			
			switchMap(planOverlay2,map3);
		});
	}
	
	function disableSync()
	{
	    google.maps.event.clearListeners(map2, 'center_changed');
	    google.maps.event.clearListeners(map2, 'zoom_changed');
	}
		
	function enableSync()
	{
	    map3.panTo(map2.getCenter());
	    map3.setZoom(map2.getZoom());
	    //adding event listener to sync maps
	    google.maps.event.addListener(map2, 'center_changed', function(event) {
	       map3.panTo(map2.getCenter());
	    });
	    google.maps.event.addListener(map2, 'zoom_changed', function(event) {
			map3.setZoom(map2.getZoom());
		}); 
	}
	
	function rotate(num)
	{
	    var curangle = $('#map2').getRotateAngle();
	    var nextangle = Number(curangle) + Number(num);
	    if(num === 0) nextangle = 0;
	
	    $('#map').rotate({
	        angle: curangle, 
	        animateTo: nextangle
	    })
	    $('#map2').rotate({
	        angle: curangle, 
	        animateTo: nextangle
	    })
	    $('#map3').rotate({
	        angle: curangle, 
	        animateTo: nextangle
	    })
	}

	function dualView(viewState)
	{
		if (viewState == 0)
		{
			$('#mapcontainer2').hide();
			$('#mapcontainer').show();
			$('#map-nav2').hide();
			$('#map-nav').show();

			map1 = new ol.Map({
				interactions: ol.interaction.defaults().extend([
					new ol.interaction.DragRotateAndZoom()
				]),
				layers: [layers[0]],
				// Use the canvas renderer because it's currently the fastest
				renderer: ol.RendererHint.CANVAS,

				target: 'map2',
				view: new ol.View2D({
					center: ol.proj.transform([centerLatLon.lng(),centerLatLon.lat()], 'EPSG:4326', 'EPSG:3857'),
					zoom: zoomLevel
				})
			});

		}
		else if (viewState == 1)
		{
			$('#mapcontainer').hide();
			$('#mapcontainer2').show();
			$('#map-nav').hide();
			$('#map-nav2').show();

			map2 = new ol.Map({
				interactions: ol.interaction.defaults().extend([
					new ol.interaction.DragRotateAndZoom()
				]),
				layers: [layers[0]],
				// Use the canvas renderer because it's currently the fastest
				renderer: ol.RendererHint.CANVAS,

				target: 'map2',
				view: new ol.View2D({
					center: ol.proj.transform([centerLatLon.lng(),centerLatLon.lat()], 'EPSG:4326', 'EPSG:3857'),
					zoom: zoomLevel
				})
			});

			map3 = new ol.Map({
				interactions: ol.interaction.defaults().extend([
					new ol.interaction.DragRotateAndZoom()
				]),
				layers: [layers[1]],
				// Use the canvas renderer because it's currently the fastest
				renderer: ol.RendererHint.CANVAS,

				target: 'map3',
				view: new ol.View2D({
					center: ol.proj.transform([centerLatLon.lng(),centerLatLon.lat()], 'EPSG:4326', 'EPSG:3857'),
					zoom: zoomLevel
				})
			});


			// map2 = new google.maps.Map(document.getElementById("map2"), myOptions2);
			// map3 = new google.maps.Map(document.getElementById("map3"), myOptions3);
			// enableSync();
			// switchMap(planOverlay,map2);
			// enforceMaxZoom(map2,true);
			// enforceMaxZoom(map3,false);

			
		}
	}
	
    function init(){
    	


		var styles = ['Aerial'];		

		// for (var i = 0; i < styles.length; ++i) {
		// 		layers.push(new ol.layer.Tile({
		// 		visible: true,
		// 		preload: Infinity,
		// 		source: new ol.source.BingMaps({
		// 			key: 'AsLC8oRsjQe-8GwEH5-lVCJVGwfC9nI0zkrNieraR2-50b3jWISl-MgqJckubro0',
		// 			imagerySet: styles[i]
		// 		})
		// 		}));
		// }


		// arclayer = new ol.layer.Tile({
		// 	      source: new ol.source.XYZ({
		// 	        url: tileURL+'{z}/{x}/{y}.png'
		// 	      })
		// 	    });

		map1 = new ol.Map({
			interactions: ol.interaction.defaults().extend([
				new ol.interaction.DragRotateAndZoom()
			]),
			layers: layers,
			// Use the canvas renderer because it's currently the fastest
			renderer: ol.RendererHint.CANVAS,

			target: 'map',
			view: new ol.View2D({
				center: ol.proj.transform([centerLatLon.lng(),centerLatLon.lat()], 'EPSG:4326', 'EPSG:3857'),
				zoom: zoomLevel
			})
		});

return false;

		myOptions1 = {
			zoom: zoomLevel,
			center: centerLatLon,
		    mapTypeId: google.maps.MapTypeId.ROADMAP,
		    mapTypeControl: false,
		    mapTypeControlOptions: {
		      style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
		    },
		    panControl: false,
		    zoomControl: false,
			zoomControlOptions: {
				style: google.maps.ZoomControlStyle.SMALL
			},
			maxZoom: 24
		};
		map = new google.maps.Map(document.getElementById("map"), myOptions1);
		switchMap(planOverlay,map);
		
		myOptions2 = {
			zoom: zoomLevel,
			center: centerLatLon,
		    mapTypeId: google.maps.MapTypeId.HYBRID,
		    mapTypeControl: true,
		    mapTypeControlOptions: {
		      style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
		    },
		    panControl: false,
		    zoomControl: true,
			zoomControlOptions: {
				style: google.maps.ZoomControlStyle.SMALL
			},
			maxZoom: 24
		};
		// map2 = new google.maps.Map(document.getElementById("map2"), myOptions2);
		//switchMap(planOverlay);
		
		myOptions3 = {
			zoom: zoomLevel,
			center: centerLatLon,
		    mapTypeId: google.maps.MapTypeId.HYBRID,
		    mapTypeControl: true,
		    mapTypeControlOptions: {
		      style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
		    },
		    panControl: false,
		    zoomControl: true,
			zoomControlOptions: {
				style: google.maps.ZoomControlStyle.SMALL
			},
			maxZoom: 24			
		};
		// map3 = new google.maps.Map(document.getElementById("map3"), myOptions3);
		
		enforceMaxZoom(map,true);
		
		//get related plans for dual view drop down
		getRelatedPlans();
    }

	function enforceMaxZoom(map,switch2map)
	{
		//attempting to allow maxzoom beyond 21 (buggy)
	    google.maps.event.addListener(map, 'tilesloaded', function (event) {
	        var mapTypeRegistry = map.mapTypes;
	        var currentMapTypeId = map.getMapTypeId();
	        var mapType = mapTypeRegistry.get(currentMapTypeId);
	        mapType.maxZoom = 24;

	    });
	    
	    google.maps.event.addListener(map, 'maptypeid_changed', function (event) {
	        map.setOptions({ maxZoom: 24 });
	    });

		// max zoom to 24 only works when you switch away from map type to satellite type and back to map type
		// this "hack" will automate the switch to force maxzoom 24
		var defaultzoom = map.getZoom();
		setTimeout(function(){
			map.setMapTypeId(google.maps.MapTypeId.SATELLITE)
			setTimeout(function(){
				if(switch2map)
				{
					map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
				}
				if(defaultzoom != map.getZoom())
				{
					map.setZoom(defaultzoom);
				}
				
				},100);
			
		},1000);		
	}
	function switchMap(planOverlay,map)
	{
		
		map.overlayMapTypes.setAt(0, null);
		map.overlayMapTypes.insertAt(0, planOverlay);
	    var handle = document.getElementById('handle'),
	        start,
	        startTop;
	
	    document.onmousemove = function(e) {
	        if (!start) return;
	        // Adjust control
	        handle.style.top = Math.max(-5, Math.min(195, startTop + parseInt(e.clientY, 10) - start)) + 'px';
	        // Adjust opacity
	        planOverlay.setOpacity(1 - (handle.offsetTop / 200));
	        // map.parent.style.cursor = 'ns-resize';
	    }
	
	    handle.onmousedown = function(e) {
	        // Record initial positions
	        start = parseInt(e.clientY, 10);
	        startTop = handle.offsetTop - 5;
	        return false;
	    }
	
	    document.onmouseup = function(e) {
	        start = null;
	    }
	}
	
	function toggleSync()
	{
		if($('#sync').html() == 'Sync Maps')
		{
			$('#sync').html('Disable Sync');
			enableSync();
		}
		else
		{
			$('#sync').html('Sync Maps');
			disableSync();
		}
	}
</script>

<!-- ------------------------------------------------------------------------------------------------------ -->		    
	

  </head>

<body onload="init()"><!-- bootstrap header/old nav saved to old_nav.php -->
<div id="wrap"> <!-- part of flush footer (not working with just bootstrap. See CSS fix-->



	<!-- Map -->

<div id="master-map-container" style="position: relative" >
	
	<!-- transparency slider -->
	

	<!-- single map -->
	<!-- map navigation bar -->
	<div id="map-nav" class="well container-fluid">
		<!-- <input type="radio" id="radio01" name="radio" checked="checked" /><label for="radio01">Single View</label>
		<input type="radio" id="radio02" name="radio" /><label for="radio01">Dual View</label> -->
		<span class="btn btn-small" onclick="dualView(0)"><i class="icon-stop"></i> Single View</span>
		<span class="btn btn-small" onclick="dualView(1)"><i class="icon-stop"></i><i class="icon-stop"></i> Dual View</span>
		|
		<!-- rotate the maps -->
          <span class="btn btn-small btn-info" onclick="rotate(-5);"><i class="icon-arrow-left icon-white"></i></span>
          <span class="btn btn-small btn-info" onclick="rotate(0);"><i class="icon-refresh icon-white"></i>rotate</span>
          <span class="btn btn-small btn-info" onclick="rotate(5);"><i class="icon-arrow-right icon-white"></i></span>

		<!-- show full screen button
					<a href="http://dev.aegaron.ucla.edu/index.php/welcome/fullscreen/21198_zz002c2g4c/" target="_blank" title="full screen" class="btn btn-small btn-inverse" style="float: right"><i class="icon-fullscreen icon-white"></i></a>
		 -->

	</div>
	
	<!-- dual map navigation -->
	<div id = "map-nav2" style="display:none;" class="well container-fluid">
		<span class="btn btn-small" onclick="dualView(0)"><i class="icon-stop"></i> Single View</span>
		<span class="btn btn-small" onclick="dualView(1)"><i class="icon-stop"></i><i class="icon-stop"></i> Dual View</span>
          <!-- <span class="btn btn-small btn-inverse" onclick="disableSync()">Unsync Maps</span> -->
		|
		<!-- rotate the maps -->
          <span class="btn btn-small btn-info" onclick="rotate(-5);"><i class="icon-arrow-left icon-white"></i></span>
          <span class="btn btn-small btn-info" onclick="rotate(0);"><i class="icon-refresh icon-white"></i>rotate</span>
          <span class="btn btn-small btn-info" onclick="rotate(5);"><i class="icon-arrow-right icon-white"></i></span>
		

	</div>
	
	<div id="map-nav3" class="well" style="display:none;">single | dual</div>

	<!-- map container for single map view -->
	<div id="mapcontainer" style="position: relative;">
		<div style="float: left;position: absolute;margin-top: 10px;margin-left: 10px;z-index: 100;">
			<button class="btn btn-mini btn-inverse" onclick="map1.getView().setZoom(map1.getView().getZoom()+1)"><i class="icon-zoom-in icon-white"></i></button>
			<button class="btn btn-mini btn-inverse" onclick="map1.getView().setZoom(map1.getView().getZoom()-1)"><i class="icon-zoom-out icon-white"></i></button>
		</div>
		<div style="clear: both;"></div>
		<div id="mapcontainer1"><div id="map">This will be a map</div><div class="reticule"></div></div>

		<!-- <div id="map" style="background-color: gray;width:100%;height:600px;"></div> -->
		
	</div>
	
	<!-- map container for dual map view -->
	<div id="mapcontainer2" style="position: relative;display:none;">
		<div style="float: left;position: absolute;margin-top: 10px;margin-left: 10px;z-index: 100;">
			<button class="btn btn-mini btn-inverse" onclick="map2.getView().setZoom(map2.getView().getZoom()+1)"><i class="icon-zoom-in icon-white"></i></button>
			<button class="btn btn-mini btn-inverse" onclick="map2.getView().setZoom(map2.getView().getZoom()-1)"><i class="icon-zoom-out icon-white"></i></button>
		</div>
		<div style="float: right;position: absolute;margin-top: 10px;right: 10px;z-index: 100;">
			<!-- <select class="span2" style="margin-bottom:0px;" onChange="switchCompareMap()" id="changecompare">
				<option value=1>Satellite</option> 
			</select> -->
			<button class="btn btn-mini btn-inverse" onclick="map3.getView().setZoom(map3.getView().getZoom()+1)"><i class="icon-zoom-in icon-white"></i></button>
			<button class="btn btn-mini btn-inverse" onclick="map3.getView().setZoom(map3.getView().getZoom()-1)"><i class="icon-zoom-out icon-white"></i></button>
		</div>
		<div style="clear: both;"></div>
		<div id="mapcontainer2-1"><div id="map2">This will be a map</div><div class="reticule"></div></div>
    	<div id="mapcontainer2-2"><div id="map3">This will be a map</div><div class="reticule"></div></div>



		
	</div>
</div>
</div></div></div>

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
	<script type="text/javascript" src="http://dev.aegaron.ucla.edu/js/aegaron.js"></script>
	<script type="text/javascript" src="http://dev.aegaron.ucla.edu/js/jquery.js"></script>
	<script type="text/javascript" src="http://dev.aegaron.ucla.edu/js/jrotate.js"></script>
	<script type="text/javascript" src="http://dev.aegaron.ucla.edu/bootstrap/js/bootstrap.min.js"></script>
	<!-- old JS includes from former bootstrap version 	
    <script src="http://dev.aegaron.ucla.edu/bootstrap/docs/assets/js/jquery.js"></script>
    <script src="http://dev.aegaron.ucla.edu/bootstrap/docs/assets/js/bootstrap-transition.js"></script>
    <script src="http://dev.aegaron.ucla.edu/bootstrap/docs/assets/js/bootstrap-alert.js"></script>
    <script src="http://dev.aegaron.ucla.edu/bootstrap/docs/assets/js/bootstrap-modal.js"></script>
    <script src="http://dev.aegaron.ucla.edu/bootstrap/docs/assets/js/bootstrap-dropdown.js"></script>
    <script src="http://dev.aegaron.ucla.edu/bootstrap/docs/assets/js/bootstrap-scrollspy.js"></script>
    <script src="http://dev.aegaron.ucla.edu/bootstrap/docs/assets/js/bootstrap-tab.js"></script>
    <script src="http://dev.aegaron.ucla.edu/bootstrap/docs/assets/js/bootstrap-tooltip.js"></script>
    <script src="http://dev.aegaron.ucla.edu/bootstrap/docs/assets/js/bootstrap-popover.js"></script>
    <script src="http://dev.aegaron.ucla.edu/bootstrap/docs/assets/js/bootstrap-button.js"></script>
    <script src="http://dev.aegaron.ucla.edu/bootstrap/docs/assets/js/bootstrap-collapse.js"></script>
    <script src="http://dev.aegaron.ucla.edu/bootstrap/docs/assets/js/bootstrap-carousel.js"></script>
    <script src="http://dev.aegaron.ucla.edu/bootstrap/docs/assets/js/bootstrap-typeahead.js"></script>-->

  </body>
</html>
